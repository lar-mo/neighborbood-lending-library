{% extends 'lendingLibrary/base.html' %}

{% block title %}
<title>Edit Item - Neighborhood Lending Library</title>
{% endblock %}

{% block heading %}
<h2>Manage Your Items</h2>
{% endblock %}

{% block content %}
<div id="crud_options"> <!-- start of 'crud_options' -->
    <table>
      <tr>
        <th>ADD</th>
        <th>EDIT</th>
        <th>DELETE</th>
      </tr>
      <tr>
        <td style="text-align:center">
          <button style="margin:0 50px" id="btn_add_item">Add an Item</button>
        </td>
        <td style="text-align:center">
          Select one of your items:<br/>
          <select id="sel_user_items" required>
            <option disabled selected value="">-----</option>
          {% for item in items %}
            <option value="{{item.id}}">{{item.name}}</option>
          {% endfor %}
          </select>
          <button id="btn_load_data">Load Data</button>
        </td>
        <td style="text-align:center">
          <div>
            <form action="{% url 'lendingLibrary:delete_item' %}" method="post">
              {% csrf_token %}
              Select one of your items:<br/>
              <select name="user_items" id="select_user_items" required>
                <option disabled selected value="">-----</option>
              {% for item in items %}
                <option value="{{item.id}}">{{item.name}}</option>
              {% endfor %}
              </select>
              <button type="submit" id="btn_delete">Delete</button>
            </form>
          </div>
        </td>
      </tr>
    </table>
</div> <!-- end of 'crud_options' -->
<div class="spacer"></div>
<div id="edit_item"> <!-- start of 'edit_item' -->
  <table>
    <tr>
      <th><h2>Edit an item</h2></th>
    </tr>
    <tr>
      <td>
        <div class="add_edit_form_div">
          <form action="{% url 'lendingLibrary:save_edited_item' %}" method="post" name="edit_item" id="edit_item_form">
            {% csrf_token %}
            <div class="field_label">Name</div>
            <div>
              <input name="name" type="text" value="{{item.name}}" style="width: 300px" required>
            </div>
            <div class="field_label">Description</div>
            <div>
              <textarea name="description" style="width: 300px">{{item.description}}</textarea>
            </div>
            <div class="field_label">Image URL</div>
            <div>
              <input name="image_url" type="text" value="{{item.image_url}}" style="width: 300px">
            </div>
            <div class="field_label">Category</div>
            <div>
              <select name="category" value="" style="width: 300px" required>
                {% for category in categories %}
                  {% if item.category.id == category.id %}
                    <option value="{{category.id}}" selected>{{category.name}}</option>
                  {% else %}
                    <option value="{{category.id}}">{{category.name}}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="field_label">Condition</div>
            <div>
              <select name="condition" value="" style="width: 300px" required>
                {% for condition in conditions %}
                  {% if item.condition.id == condition.id %}
                    <option value="{{condition.id}}" selected>{{condition.name}}</option>
                  {% else %}
                    <option value="{{condition.id}}">{{condition.name}}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="field_label">Replacement Cost</div>
            <div>
              <input name="replacement_cost" type="number" value="{{item.replacement_cost}}" style="width: 300px" required>
            </div>
            {% if item.item_status.name != "Checked Out" %}
              <div class="field_label">Item Status</div>
              <div>
                <select name="item_status" style="width: 300px" required>
                  {% for item_status in item_statuses %}
                    {% if item.item_status.id == item_status.id %}
                      <option value="{{item_status.id}}" selected>{{item_status.name}}</option>
                    {% else %}
                      <option value="{{item_status.id}}">{{item_status.name}}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            {% else %}
              <span></span> <!-- kludge prevents button indent due to CSS odd/even rules :( -->
              <input type="hidden" name="item_status" value="{{item.item_status.id}}"/>
            {% endif %}
            <div class="form_submit_div">
              <input type="submit" value="Save item" class="form_submit_button"/>
            </div>
            <input type="hidden" name="item_id" value="{{item.id}}"/>
          </form>
        </div>
      </td>
    </tr>
  </table>
</div> <!-- end of 'edit_item' -->
{% endblock %}

{% block script %}
      let btn_add_item = document.querySelector('#btn_add_item')
      btn_add_item.onclick = function() {
        window.location={% url 'lendingLibrary:new_item' %}
      }

      let btn_delete = document.querySelector('#btn_delete')
      let select_item_delete = document.querySelector('#select_user_items')
      btn_delete.onclick = function(event) {
        if (select_item_delete.value == '') {
          alert("You have to select an item first.")
          event.preventDefault()
        } else {
          let answer = confirm("Are you sure you want to delete \"" + select_item_delete.options[select_item_delete.selectedIndex].text + "\"?\n\nThis action cannot be undo.")
          if (!answer) {
            event.preventDefault()
          } // end of inner 'if statement'
        } // end of outer 'if statement'
      } // end of 'onclick'

      let btn_load_data = document.querySelector('#btn_load_data')
      let sel_user_items = document.querySelector('#sel_user_items')
      btn_load_data.onclick = function(event) {
        if (sel_user_items.value == '') {
          alert('You have to select an item first.')
        } else {
          let sel_item_id = sel_user_items.options[sel_user_items.selectedIndex].value
          url = '/edit_item/' + sel_item_id + '/'
          window.location = url
        } // end of outer 'if statement'
      } // end of 'onclick'
{% endblock %}
